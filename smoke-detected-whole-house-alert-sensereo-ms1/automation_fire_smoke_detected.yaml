- id: bt_smoke_ms1_whole_house_alert
  alias: "BT â€¢ Smoke Detected â†’ Whole House Alert (Sensereo MS1)"
  description: >
    Critical alert when smoke is detected. Sends push + Telegram and optionally triggers
    TTS/scenes/HVAC shutdown. Includes cooldown to avoid repeated alerts.
  mode: single

  variables:
    smoke_entity: binary_sensor.upper_landing_smoke_smoke
    notify_push: notify.mobile_app_pixel_9_pro_xl
    notify_telegram: notify.telegram_ebrzsmbrbot

    # Cooldown in minutes (rate limit)
    cooldown_minutes: 10

    # Optional actions (edit or remove)
    tts_script: script.say_living_room
    hvac_switches:
      - switch.HVAC_SWITCH_1
      - switch.HVAC_SWITCH_2
    alert_scene: scene.ALERT_SCENE
    alert_lights:
      - light.garden_lights

  trigger:
    - platform: state
      entity_id: binary_sensor.upper_landing_smoke_smoke
      to: "on"

  condition:
    # Cooldown using this automation's last_triggered timestamp
    - condition: template
      value_template: >
        {% set last = this.attributes.last_triggered %}
        {{ last is none or (now() - last).total_seconds() > (cooldown_minutes * 60) }}

  action:
    - variables:
        ts: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        msg: >
          ðŸ”¥ SMOKE DETECTED! ({{ ts }})
          Entity: {{ smoke_entity }}
          Check immediately.

    - service: "{{ notify_push }}"
      data:
        title: "ðŸ”¥ Smoke detected!"
        message: "{{ msg }}"
        data:
          priority: high

    - service: "{{ notify_telegram }}"
      data:
        message: "{{ msg }}"

    # Optional: TTS
    # If you don't have the script, comment/remove this block.
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ tts_script is string and tts_script | length > 0 }}"
          sequence:
            - service: "{{ tts_script }}"
              data:
                message: "Warning! Smoke detected. Please check immediately."

    # Optional: activate alert scene
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ alert_scene is string and alert_scene | length > 0 }}"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: "{{ alert_scene }}"

    # Optional: turn on some lights
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ alert_lights | length > 0 }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: "{{ alert_lights }}"
              data:
                brightness_pct: 100

    # Optional: shut down HVAC switches
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ hvac_switches | length > 0 }}"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: "{{ hvac_switches }}"
