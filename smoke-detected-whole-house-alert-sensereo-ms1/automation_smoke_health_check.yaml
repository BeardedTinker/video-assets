- id: bt_smoke_ms1_health_check
  alias: "BT â€¢ Smoke Detector Daily Health Check (Sensereo MS1)"
  description: >
    Daily check: warns if the smoke entity becomes unavailable/unknown.
    Keeps it calm (no spam) with 24h cooldown.
  mode: single

  variables:
    smoke_entity: binary_sensor.upper_landing_smoke_smoke
    notify_push: notify.mobile_app_pixel_9_pro_xl
    notify_telegram: notify.telegram_ebrzsmbrbot
    cooldown_hours: 24

  trigger:
    - platform: time
      at: "09:00:00"

  condition:
    - condition: template
      value_template: >
        {{ states(smoke_entity) in ['unavailable', 'unknown'] }}
    - condition: template
      value_template: >
        {% set last = this.attributes.last_triggered %}
        {{ last is none or (now() - last).total_seconds() > (cooldown_hours * 3600) }}

  action:
    - variables:
        ts: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        msg: >
          ðŸ“¡ Smoke detector health check failed ({{ ts }})
          {{ smoke_entity }} is {{ states(smoke_entity) }}.
          Check Thread/Matter connectivity and device status.

    - service: "{{ notify_push }}"
      data:
        title: "ðŸ“¡ Smoke detector offline?"
        message: "{{ msg }}"

    - service: "{{ notify_telegram }}"
      data:
        message: "{{ msg }}"
